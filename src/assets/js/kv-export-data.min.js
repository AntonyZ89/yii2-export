/*!
 * @package   yii2-export
 * @author    Kartik Visweswaran <kartikv2@gmail.com>
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2015 - 2020
 * @version   1.4.1
 *
 * Export Data Validation Module.
 *
 */
!function(t){"use strict";var e,o;e={DIALOG:"kvExportDialog",IFRAME:"kvExportIframe",LOADING:"kvExportLoading",TARGET_POPUP:"_popup",TARGET_IFRAME:"_iframe",isEmpty:function(e,o){return null==e||e===[]||""===e||o&&""===t.trim(e)},createPopup:function(t,e,o){var n=screen.width/2-e/2;return window.open("",name,"",!0).close(),window.open("",t,"toolbar=no, location=no, directories=no, status=yes, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+e+", height="+o+", top=60, left="+n)},createIframe:function(e){var o=t('iframe[name="'+e+'"]');return o.length?o:t("<iframe/>",{name:e,css:{display:"none"}}).appendTo("body")},createLoadingModal:function(e,o){const n=t("<div/>",{id:e,class:"kv-export-background"}),a=t("<div/>",{class:"kv-export-modal",text:o}),i=t("<div/>"),r=t('<div class="kv-export-loader"/>');return i.append(r),a.append(i),n.append(a),n.appendTo("body")},popupTemplate:'<html style="display:table;width:100%;height:100%;"><title>Export Data - &copy; Krajee</title><body style="display:table-cell;font-family:Helvetica,Arial,sans-serif;color:#888;font-weight:bold;line-height:1.4em;text-align:center;vertical-align:middle;width:100%;height:100%;padding:0 10px;">{msg}</body></html>'},(o=function(e,o){var n=this;n.$element=t(e),t.each(o,function(t,e){n[t]=e}),n.popup="",n.iframe="",n.loading="",n.listen()}).prototype={constructor:o,listen:function(){var o=this;t(document).on("click.exportmenu","#"+o.$element.attr("id"),function(n){var a,i,r,s,p,l="",d=window[o.settings.dialogLib];a=t(this).data("format"),n.preventDefault(),n.stopPropagation(),o.settings.showConfirmAlert?(i=o.settings.messages,r=e.isEmpty(o.alertMsg)?"":o.alertMsg,s=e.isEmpty(i.allowPopups)?"":i.allowPopups,p=e.isEmpty(i.confirmDownload)?"":i.confirmDownload,l=r.length&&s.length?r+"\n\n"+s:!r.length&&s.length?s:r.length&&!s.length?r:"",p.length&&(l=l+"\n\n"+p),e.isEmpty(l)?o.processExport(a):d.confirm(l,function(t){t&&o.processExport(a)})):o.processExport(a)})},setPopupAlert:function(t){if(this.popup.document)if(arguments.length&&arguments[1]){var o=this.popup.document.getElementsByTagName("body");setTimeout(function(){o[0].innerHTML=t},1800)}else{var n=e.popupTemplate.replace("{msg}",t);this.popup.document.write(n)}},setLoadingModalAlert:function(){this.loading.fadeOut(1e3)},processExport:function(o){var n,a,i,r,s,p=[],l=window.yii,d=this.settings,c=function(e,o){return t("<textarea/>",{name:e}).val(o).hide()};i=t.extend(!0,{},d.formOptions,{action:window.location.href,target:d.target,method:"post",css:{display:"none"}}),(a=d.target===e.TARGET_POPUP)?(this.popup=e.createPopup(e.DIALOG,350,120),this.popup.focus(),this.setPopupAlert(this.settings.messages.downloadProgress),i.target=e.DIALOG):d.target===e.TARGET_IFRAME?(this.iframe=e.createIframe(e.IFRAME),i.target=e.IFRAME):this.loading=e.createLoadingModal(e.LOADING,this.settings.messages.downloadProgress),n=l?c(l.getCsrfParam()||"_csrf",l.getCsrfToken()||null):null,r="",e.isEmpty(d.colSelId)||(t("#"+d.colSelId).parent().find('input[name="export_columns_selector[]"]').each(function(){var e=t(this);e.is(":checked")&&p.push(e.attr("data-key"))}),r=JSON.stringify(p)),console.log(r),s=t("<form/>",i).append(n).append(c(d.exportTypeParam,o),c(d.exportRequestParam,1)).append(c(d.exportColsParam,r),c(d.colSelFlagParam,d.colSelEnabled)).appendTo("body"),e.isEmpty(d.exportFormHiddenInputs)||t.each(d.exportFormHiddenInputs,function(e,o){var n={name:e,value:o.value||null,type:"hidden"};n=t.extend({},n,o.options||{}),s.append(t("<input/>",n))}),s.submit().remove(),this.loading?this.setLoadingModalAlert():a&&this.setPopupAlert(this.settings.messages.downloadComplete,!0)}},t.fn.exportdata=function(e){var n=Array.apply(null,arguments);return n.shift(),this.each(function(){var a=t(this),i=a.data("exportdata"),r="object"==typeof e&&e;i||a.data("exportdata",i=new o(this,t.extend({},t.fn.exportdata.defaults,r,t(this).data()))),"string"==typeof e&&i[e].apply(i,n)})},t.fn.exportdata.defaults={alertMsg:"",settings:{formOptions:{},exportType:"",colSelEnabled:"",exportRequestParam:"",exportTypeParam:"",exportColsParam:"",exportFormHiddenInputs:{},colSelId:null,target:"",showConfirmAlert:!0,dialogLib:"krajeeDialog",messages:{allowPopups:"",confirmDownload:"",downloadProgress:"",downloadComplete:""}}}}(window.jQuery);
